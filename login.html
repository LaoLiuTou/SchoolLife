<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>用户注册</title>
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta content="telephone=no" name="format-detection">
		<link rel="stylesheet" href="css/weui.css">
		<link rel="stylesheet" href="css/jquery-weui.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="css/swipeslider.css">
	</head>
	<style>
		::-webkit-input-placeholder { 
		  color: #999;
		}
	</style>

	<body>
		<div class="head ">
			<div class="indexreturn bbqreturn" onclick="window.history.go(-1)">
				<img src="images/houtui-icon.png" />
			</div>
			用户注册

		</div>
		<div id="addForm"  class="personal pt50 bbqperson bbqlogin">
			<div class="weui-cells weui-cells_form">
				<div class="weui-cells m0">
				  <div class="weui-cell">
					<div class="weui-cell__hd">
						学生证照片拍摄
					</div>
					<div class="tpzhengjian">
						<!--<input type="file" id="std_id_img" style="display:none;" multiple capture='camera' accept='image/*'>-->
						<input type="file" id="std_id_img" style="display:none;" capture='camera' accept='image/*'>
						<img id="idphoto" src="images/shenfenzheng3.png">
					</div>
				  </div>
				</div>

				<div class="weui-cell">
					<div class="weui-cell__hd">
						<label class="weui-label">真实姓名</label>
					</div>
					<div class="weui-cell__bd">
						<input class="weui-input wid100" type="text" id="nm_t" t="data" placeholder="请输入真实姓名">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__hd">
						<label class="weui-label">昵称</label>
					</div>
					<div class="weui-cell__bd">
						<input class="weui-input wid100" type="text" id="nickname" t="data" placeholder="请输入昵称">
					</div>
				</div>

				<div class="weui-cell weui-cell_vcode">
				    <div class="weui-cell__hd">
				      <label class="weui-label">手机号</label>
				    </div>
				    <div class="weui-cell__bd">
				      <input class="weui-input wid100" type="tel" id="ph_p" t="data" placeholder="请输入手机号">
				    </div>
				    <div class="weui-cell__ft">
				      <button class="weui-vcode-btn" id="codeBtn">获取验证码</button>
				    </div>
			    </div>
				<div class="weui-cell weui-cell_vcode">
					<div class="weui-cell__hd"><label class="weui-label">验证码</label></div>
					<div class="weui-cell__bd">
						<input class="weui-input wid100" type="number" id="code" placeholder="请输入验证码">
					</div>
				</div>
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__hd">
				      <label class="weui-label">性别</label>
				    </div>
					<div class="weui-cell__bd">
						<input type="text" class="weui-input wid100" id='se_lv' t="data" value="男" placeholder="请选择性别">
					</div>
					<div class="weui-cell__ft">
					</div>
				</div>
			</div>
			<div class="weui-cell weui-cell_access">
				<div class="weui-cell__hd">
				      <label class="weui-label">学校</label>
				    </div>
				<div class="weui-cell__bd">
					<input class="weui-input wid100" type="text" id="city-picker" placeholder="吉林 长春 吉大 " value="">
					<input style="display:none;"  type="text" id="sc_id"  t="data"  value="">
				</div>
				<div class="weui-cell__ft">
				</div>
			</div>
			<div class="weui-cell weui-cell_access">
				<div class="weui-cell__hd">
				      <label class="weui-label">学院</label>
				    </div>
				<div class="weui-cell__bd">
					<input type="text" class="weui-input wid100" id='xueyuan' placeholder="请选择学院">
					<input  style="display:none;" type="text" id="ac_id"  t="data"  value="">
				</div>
				<div class="weui-cell__ft">
				</div>
			</div>
			<div class="weui-cell weui-cell_access">
				<div class="weui-cell__hd">
				      <label class="weui-label">专业</label>
				    </div>
				<div class="weui-cell__bd">
					<input type="text" class="weui-input wid100" id='zhuanye' placeholder="请选择专业">
					<input type="text" style="display:none;" id="ma_id"  t="data"  value="">
				</div>
				<div class="weui-cell__ft">
				</div>
			</div>

			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">学号</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input wid100" type="number" id="sn_t"  t="data" placeholder="请输入学号">
				</div>
			</div>
			 <div class="weui-cell weui-cell_access">
			    <div class="weui-cell__hd">
			      <label class="weui-label">入学日期</label>
			    </div>
			    <div class="weui-cell__bd">
			      <input type="text" class="weui-input wid100" id='rd_d'  t="data" placeholder="2000-1-1">
			    </div>
			    <div class="weui-cell__ft">
			    </div>
			  </div>
			  <div class="weui-cell weui-cell_access">
				<div class="weui-cell__hd">
				      <label class="weui-label">年级</label>
				    </div>
				<div class="weui-cell__bd">
					<input type="text" class="weui-input wid100" id='nj_d' t="data" placeholder="请选择年级">
				</div>
				<div class="weui-cell__ft">
				</div>
			</div>
			<div class="weui-cell">
				<div class="weui-cell__hd">
					<label class="weui-label">邮箱</label>
				</div>
				<div class="weui-cell__bd">
					<input class="weui-input wid100" type="email" id="email"  t="data" placeholder="请输入邮箱">
				</div>
			</div>
			 <div style="padding:10px;">
		       <a href="javascript:;" class="weui-btn weui-btn_primary"  id="submitBtn">提 交</a>
		    </div>
		</div>

		<script src="js/jquery.min.js"></script>
		<script src="js/jquery-weui.min.js"></script>
		<script src="js/city-picker.min.js"></script>



		<!--具体功能实现-->
		<script type="text/javascript" src="js/main/config.js"></script>
		<script>
			var randomCode='';
            var bodyParam={};
            var image;
            var schoolTree=[];
            var firstValue;
            var xueyuanKeyArr=[];
            var xueyuanValueArr=[];
            var zhuanyeKeyArr=[];
            var zhuanyeValueArr=[];
            $(document).ready(function () {


                /*异步加载学校数据*/
                //listSchool();
                // 地区
                $("#city-picker").cityPicker({
                    title: "请选择学校",

                    onOpen: function(d){
                        //console.log(this, d);
                    },
                    onChange: function(d){
                        //console.log(this, d);
                    },
                    onClose: function(d){
                        //console.log( d.value);
						$("#sc_id").val(d.value[2]);
                        $("#xueyuan").val("");
                        $("#ac_id").val("");
                        var bodyParam = {'SC_ID': d.value[2]};
                        listAc(bodyParam) ;
                    }
                });

                // 性别
                $("#se_lv").picker({
                    title: "请选择性别",
                    cols: [{
                        textAlign: 'center',
                        values: ['男', '女']
                    }]
                });
                $("#nj_d").picker({
                    title: "请选择年级",
                    cols: [{
                        textAlign: 'center',
                        values: ['大一', '大二', '大三', '大四', '研一', '研二', '研三']
                    }]
                });

                // 入学日期
                $("#rd_d").datetimePicker({
                    title: '请选择入学日期',
                    times: function () {},
                    onChange: function (picker, values, displayValues) {
                        console.log(values);
                    }
                });
                $.modal({
                    title: "提示",
                    text: "目前在校园app只对在校师生开放注册，独立注册的在校学生需要提供学生证照片（印有学校名称 院系的页面）并填写基本信息。请务必保证提交信息的准确性，管理员将在3天内对提交的信息进行审核，对审核通过的用户以短信方式通知。",
                    buttons: [
                        { text: "确定", onClick: function(){ $.toast("成功！"); } },
                        { text: "取消", className: "default"},
                    ]
                });


				$('#idphoto').click(function(){
					$('#std_id_img').click();

				});
				//上传图片
                $("#std_id_img").bind('change', function () {
                    var file = $(this).val();
                    if(file.length>0){
                        var formData = new FormData();
                        var fileArr=$('#std_id_img').prop('files');
						for(var o in fileArr){
                            formData.append("image", fileArr[o]);
						}
                        $.ajax({
                            type: "post",
                            url: url +"uploadImg",
                            //url: 'http://192.168.1.144/FileUS/filesUpload',
                            data: formData,
                            contentType: false, // 注意这里应设为false
                            processData: false,    //false
                            cache: false,    //缓存
                            success: function(response){
                                var obj = JSON.parse(response);
                                var code = obj['Code'];
                                if(code=='1'){
                                    var result = obj['Result'];
                                    image=result;
                                    $('#idphoto').prop('src',image);
								}
								else{
                                    $.toast("上传文件失败！", "text");
								}

                            }
                        })
                    }
                });

                //验证码
				$('#codeBtn').click(function(){
				    if(!isPoneAvailable($('#ph_p').val())){
                        $.toast("手机号不正确！", "text");
				        return;
					}
					else{
                        var bodyParam = {'PH_P':$('#ph_p').val()};
                        sendIdCode(bodyParam);
					}

				});
				$('#submitBtn').click(function(){

				    if(image==''){
                        $.toast("请上传学生证图片！", "text");
				        return;
					}
				    if($('#nm_t').val()==''){
                        $.toast("请输入学号真实姓名！", "text");
				        return;
					}
				    if($('#nickname').val()==''){
                        $.toast("请输入学号昵称！", "text");
				        return;
					}
                    if(!isPoneAvailable($('#ph_p').val())){
                        $.toast("手机号不正确！", "text");
                        return;
                    }
				    if($('#code').val()==''){
                        $.toast("验证码不正确！", "text");
				        return;
					}
				    if($('#ac_id').val()==''){
                        $.toast("请选择学院！", "text");
				        return;
					}
				    if($('#ma_id').val()==''){
                        $.toast("请选择专业！", "text");
				        return;
					}
				    if($('#sn_t').val()==''){
                        $.toast("请输入学号！", "text");
				        return;
					}
				    if($('#nj_d').val()==''){
                        $.toast("请选择年级！", "text");
				        return;
					}

                    $('#addForm input[t="data"]').each(function () {
                        if($(this).val()!='')
                            bodyParam[$(this).attr('id').toUpperCase()]=$(this).val();
                    });

                    bodyParam['STD_ID_IMG']=image;

                    console.log(bodyParam);
                    register(bodyParam);
				});






            });


            //限制数字
            function astrict() {
                var tarea = document.getElementById("weui-textarea");
                var maxlength = 200;
                var length = tarea.value.length;
                var count = maxlength - length;

                var sp = document.getElementById("astrict-sl");
                sp.innerHTML = count;
                if(count <= 25) {
                    sp.style.color = "red";
                } else {
                    sp.removeAttribute("style");
                }
            }


            /**
             * 学校
             */
            function listSchool(bodyParam) {
                var hrt = new HttpRequestTool(url + 'getScs', 'post', 'text', true, false, bodyParam, 'callBack');
                hrt.HttpRequest(function (response) {
                    var obj = JSON.parse(response);
                    schoolTree = obj['Result'];
                    if(schoolTree.length>0){
                        var first=schoolTree[0].name;
                        var second=schoolTree[0].sub[0].name;
                        var third=schoolTree[0].sub[0].sub[0].name;
                        firstValue=first+" "+second+" "+third;
					}

                });
            }
            /**
             * 院系
             */
            function listAc(bodyParam) {
                var hrt = new HttpRequestTool(url + 'cxAC', 'post', 'text', true, false, bodyParam, 'callBack');
                hrt.HttpRequest(function (response) {
                    var obj = JSON.parse(response);
                    var result = obj['Result'];
                    $("#zhuanye").val("");
                    $('#ma_id').val("");
                    xueyuanKeyArr=Object.keys(result);
                    xueyuanValueArr=Object.values(result);
                    $xueyuan= $("#xueyuan");
                    $parent=$("#xueyuan").parent();
                    $xueyuan.remove();
                    $parent.append($xueyuan);
                    $("#xueyuan").picker({
                        title: "请选择学院",
                        cols: [{
                            textAlign: 'center',
                            values: xueyuanValueArr
                        }]
                        ,
                        onOpen: function(d){
                            //console.log(xueyuanValueArr);
                        },
                        onChange: function(d){
                            //console.log(this, d);
                        },
                        onClose: function(d){
							var xueyuanKey=xueyuanKeyArr[xueyuanValueArr.indexOf($("#xueyuan").val())];
							$('#ac_id').val(xueyuanKey);
                            var bodyParam = {'AC_ID': xueyuanKey};
                            listMA(bodyParam);
                        }

                    });



                });
            }
            /**
             * 专业
             */
            function listMA(bodyParam) {
                var hrt = new HttpRequestTool(url + 'cxMA', 'post', 'text', true, false, bodyParam, 'callBack');
                hrt.HttpRequest(function (response) {
                    var obj = JSON.parse(response);
                    var result = obj['Result'];
                    zhuanyeKeyArr=Object.keys(result);
                    zhuanyeValueArr=Object.values(result);
                    $xueyuan= $("#zhuanye");
                    $parent=$("#zhuanye").parent();
                    $xueyuan.remove();
                    $parent.append($xueyuan);
                    $("#zhuanye").picker({
                        title: "请选择专业",
                        cols: [{
                            textAlign: 'center',
                            values: zhuanyeValueArr
                        }]
                        ,
                        onOpen: function(d){
                            //console.log(this, d);
                        },
                        onChange: function(d){
                            //console.log(this, d);

                        },
                        onClose: function(d){
                            var zhuanyeKey=zhuanyeKeyArr[zhuanyeValueArr.indexOf($("#zhuanye").val())];
                            $('#ma_id').val(zhuanyeKey);
                        }

                    });
                });
            }
            /**
             * 发送验证码
             */
            function sendIdCode(bodyParam) {
                var hrt = new HttpRequestTool(url + 'checkCode', 'post', 'text', true, false, bodyParam, 'callBack');
                hrt.HttpRequest(function (response) {
                    var obj = JSON.parse(response);
                    var result = obj['Result'];
                    console.log(result);
                });
            }
            /**
             * 注册
             */
            function register(bodyParam) {
                var hrt = new HttpRequestTool(url + 'regLife', 'post', 'text', true, false, bodyParam, 'callBack');
                hrt.HttpRequest(function (response) {
                    var obj = JSON.parse(response);
                    var result = obj['Result'];
                    if(result.length>0){
                        $.modal({
                            title: "注册成功！",
                            text: "管理员将在3天内对提交的信息进行审核，对审核通过的用户以短信方式通知。",
                            buttons: [
                                { text: "确定", className: "default" },
                                { text: "取消", className: "default"},
                            ]
                        });
					}

                });
            }

            function isPoneAvailable(str) {
                var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;
                if (!myreg.test(str)) {
                    return false;
                } else {
                    return true;
                }
            }


		</script>
	</body>

</html>